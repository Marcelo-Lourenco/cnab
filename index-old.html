<!DOCTYPE html>
<html>

<head>
  <title>CNAB - Colorido</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="./css/styles.css">
  <script src="./js/colunas-cnab-240.js"></script>
  <script src="./js/colunas-cnab-400.js"></script>
  <script src="./js/descricao-campos-240.js"></script>
  <script src="./js/descricao-campos-400.js"></script>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h3>SELECIONE O ARQUIVO CNAB</h3>
      </div>
      <div>
        <input type="file" id="fileInput" onchange="processarArquivo(event)" accept=".txt,.rem,.ret">
        <select id="codigoFiltro" onchange="exibirModal()">
          <option value="">Descrição dos Campos</option>
        </select>
      </div>
      <div>
        <h3 id="tipoArquivo">txt, rem ou ret</h3>
      </div>

    </header>
    <main>
      <div id="conteudoColorido" class="conteudo-inicial" readonly onclick="exibirTooltip(event, '')"></div>
    </main>
    <!--
    <footer>
      by: <a href="https://github.com/Marcelo-Lourenco">Marcelo Lourenço</a> - <a href="https://github.com/Marcelo-Lourenco/cnab">CNAB</a> 
    </footer>
    -->
  </div>
  <div class="modal" id="modal">
    <div class="modal-content scrollbar" id="modalContent">
      <span class="close" onclick="fecharModal()">&times;</span>
      <p id="modalContent"></p>
      <p id="descricaoModal"></p>
    </div>
  </div>
  <script>

    let layoutArquivo = "";
    /**
     * Função para identificar o layout do arquivo (CNAB240 ou CNAB400) com base na primeira linha.
     * @param {string} primeiraLinha - A primeira linha do arquivo a ser processado.
     * @returns {string} O tipo de layout do arquivo: "CNAB240" ou "CNAB400".
     */
    function identificarLayoutArquivo(primeiraLinha) {
      if (primeiraLinha.length === 240) {
        layoutArquivo = "CNAB240"
        return layoutArquivo;
      } else if (primeiraLinha.length >= 400) {
        layoutArquivo = "CNAB400"
        return layoutArquivo;
      } else {
        return `${primeiraLinha.length} Ops! O arquivo selecionado não atende o layout.`;
      }
      // return primeiraLinha.length === 240 ? "CNAB240" : "CNAB400";
    }

    /**
     * Função para exibir um tooltip com a descrição do conteúdo ao clicar em um valor.
     * @param {Event} event - O evento de clique que acionou a exibição do tooltip.
     * @param {string} descricao - A descrição do conteúdo a ser exibida no tooltip.
     */
    function exibirTooltip(event, descricao) {
      const tooltip = document.createElement("div");
      tooltip.innerText = descricao;
      tooltip.classList.add("tooltip"); // Adiciona a classe 'tooltip' ao elemento
      tooltip.style.left = `${event.clientX + 10}px`;
      tooltip.style.top = `${event.clientY + 10}px`;
      document.body.appendChild(tooltip);

      const target = event.target;
      target.classList.add("tooltip-target"); // Adiciona a classe 'tooltip-target' ao elemento

      // Remove o tooltip após 3 segundos
      setTimeout(() => {
        tooltip.remove();
      }, 3000);
      setTimeout(() => {
        target.classList.remove("tooltip-target"); // Remove a classe 'tooltip-target' do elemento
      }, 5000);
    }


    //Definição das lista com as Descrição dos Campos 
    // const descricaoCampos = [ ]

    // Definição das colunas para cada tipo de arquivo CNAB240
    // const colunasCNAB240 = {  };

    // Definição das colunas para cada tipo de arquivo CNAB400
    // const colunasCNAB400 = {   };

    /**
     * Função para colorir o texto da linha e aplicar o tooltip com base no layout do arquivo.
     * @param { string } linha - A linha do arquivo a ser colorida e processada.
     * @param { string } layoutArquivo - O tipo de layout do arquivo: "CNAB240" ou "CNAB400".
     * @returns { string } O conteúdo da linha colorida com os tooltips aplicados.
     */
    function colorirTexto(linha, layoutArquivo) {

      /**
       * Retorna a posição de um trecho dentro de uma string.
       * @param {string} ini - O trecho que se deseja buscar na string.
       * @param {string} fin - O trecho que indica o fim da busca na string.
       * @returns {Object} Um objeto contendo as propriedades "inicio" e "fim".
       */
      function posicao(ini, fin) {
        return linha.slice((ini - 1), fin);
      }

      const cores = [
        "#FFD700", // Ouro
        "#00CED1", // Azul Turquesa Média
        "#DA70D6", // Orquídea Média
        "#FF1493", // Rosa Choque
        "#8A2BE2", // Azul Violeta
        "#32CD32", // Verde Limão
        "#FF4500", // Laranja Vermelho
        "#69dcff", // Turquesa Brilhante
        "#FF6347", // Tomate
        "#1E90FF", // Azul Dodger
        "#FFA500", // Laranja
        "#ADFF2F", // Verde Amarelo
        "#FF69B4", // Rosa Choque
        "#FFFF00", // Amarelo
      ];

      let tipo = "";
      let colunasCNABTipo = [];
      let resultado = "";

      if (layoutArquivo === "CNAB240") {

        const tipoRegistro = posicao(8, 8);

        if (tipoRegistro === "0") {
          tipo = "headerArquivo";
        } else if (tipoRegistro === "1") {
          tipo = "headerLote";
        } else if (tipoRegistro === "2") {
          tipo = "iniciaisLote";
        } else if (tipoRegistro === "3") {
          if (posicao(14, 14) === "A") {
            tipo = "segmentoA";
          } else if (posicao(14, 14) === "B") {
            tipo = "segmentoB";
          } else if (posicao(14, 14) === "J" && posicao(18, 19) === "52") {
            tipo = "segmentoJ52";
          } else if (posicao(14, 14) === "J") {
            tipo = "segmentoJ";
          } else if (posicao(14, 14) === "Z") {
            tipo = "segmentoZ";
          }
        } else if (tipoRegistro === "4") {
          tipo = "finaisLote";
        } else if (tipoRegistro === "5") {
          tipo = "trailerLote";
        } else if (tipoRegistro === "9") {
          tipo = "trailerArquivo";
        } else {
          tipo = "";
        }

        colunasCNABTipo = colunasCNAB240[tipo] || [];

      } else if (layoutArquivo === "CNAB400") {

        const primeiraPosicao = posicao(1, 1);

        if (primeiraPosicao === "0") {
          tipo = "tipo0";
        } else if (primeiraPosicao === "1") {
          tipo = "tipo1";
        } else if (primeiraPosicao === "9") {
          tipo = "tipo9";
        } else {
          tipo = "outros";
        }

        colunasCNABTipo = colunasCNAB400[tipo] || [];
      }

      for (const coluna of colunasCNABTipo) {
        const [ini, fin, descricao] = coluna;
        const campo = posicao(ini, fin);
        resultado += `<span style="color: ${cores[ini % cores.length]}" title="${descricao}" onclick="exibirTooltip(event, '${descricao}')">${campo}</span>`;
      }

      return resultado;
    }


    /**
     * Função para processar o arquivo selecionado pelo usuário.
     * @param {Event} event - O evento de mudança de arquivo acionado pelo usuário.
     */
    function processarArquivo(event) {
      const file = event.target.files[0];
      const extensaoPermitida = ["txt", "rem", "ret"];

      if (file) {
        const arquivoExtensao = file.name.split(".").pop().toLowerCase();

        if (extensaoPermitida.includes(arquivoExtensao)) {
          const reader = new FileReader();

          // Alterações para identificar o layout do arquivo antes de colorir o conteúdo
          reader.onload = function (e) {
            const conteudo = e.target.result;
            const linhas = conteudo.split('\n');
            let resultadoFinal = '';

            // Identificar o layout do arquivo com base na primeira linha
            layoutArquivo = identificarLayoutArquivo(linhas[0]);

            // Antes de preencher, limpar o campo de seleção
            limparCampoDescricao();

            // Chamando a função para preencher o select ao carregar a página
            preencherCampoDescricao(layoutArquivo);

            for (const linha of linhas) {
              resultadoFinal += colorirTexto(linha, layoutArquivo) + '<br>';
            }

            document.getElementById('conteudoColorido').innerHTML = `<pre>${resultadoFinal}</pre>`;

            // Após carregar o conteúdo, alterar o background-color para #000000
            document.getElementById('conteudoColorido').classList.remove('conteudo-inicial');

            // Inserir o layout do arquivo selecionado dentro do elemento <div> com o id "tipoArquivo"
            document.getElementById('tipoArquivo').textContent = `${layoutArquivo}`;

          };

          reader.readAsText(file);
        } else {
          alert("Por favor, selecione um arquivo com extensão .txt, .rem ou .ret.");
        }
      }
    }

    /**
    * Função para limpar as opções adicionais do campo "select id='codigoFiltro'".
    */
    function limparCampoDescricao() {
      const selectElement = document.getElementById('codigoFiltro');
      const options = selectElement.getElementsByTagName('option');

      // Começar a remoção a partir do segundo elemento (índice 1) para manter a primeira opção.
      for (let i = options.length - 1; i >= 1; i--) {
        selectElement.removeChild(options[i]);
      }
    }

    let descricaoCampos = [];
    // Função para preencher o select com as opções do array descricaoCampos
    function preencherCampoDescricao(layoutArquivo) {
      const selectElement = document.getElementById('codigoFiltro');

      if (layoutArquivo === "CNAB240") {
        descricaoCampos = descricaoCampos240;
      } else {
        descricaoCampos = descricaoCampos400;
      }

      descricaoCampos.forEach(item => {
        const option = document.createElement('option');
        selectElement.appendChild(option);
        option.value = item[0];
        option.textContent = item[0];
        selectElement.appendChild(option);
      });
    }

    function exibirModal() {
      const codigoFiltro = document.getElementById("codigoFiltro").value;
      if (codigoFiltro === "") return;

      const selectedCodigo = descricaoCampos.find((item) => item[0] === codigoFiltro);

      if (selectedCodigo) {
        const descricaoModal = document.getElementById("descricaoModal");
        const descricaoFormatada = selectedCodigo[1].replace(/\n/g, "<br>").replace(/  /g, "&nbsp;&nbsp;");
        descricaoModal.innerHTML = `<pre class="descricao-modal">${selectedCodigo[0]}\n\n${descricaoFormatada}</pre>`;

        const modal = document.getElementById("modal");
        modal.style.display = "block";

        const modalContent = document.getElementById("modalContent");
        const windowHeight = window.innerHeight;
        const contentHeight = modalContent.offsetHeight;
        if (contentHeight >= windowHeight) {
          modalContent.classList.add("scrollbar");
        }
      }
    }


    function fecharModal() {
      const modal = document.getElementById("modal");
      modal.style.display = "none";
      const modalContent = document.getElementById("modalContent");
      modalContent.classList.remove("scrollbar");
    }
  </script>

</body>

</html>